![Django REST workflow](https://github.com/MaryMash/yamdb_final/actions/workflows/yamdb_workflow.yml/badge.svg)

## Описание:
### REST API для сервиса YaMDb
YaMDb - платформа, созданная для комментирования и выставления оценок различным произведениям художественной литературы, кино и музыки. 

API YaMDb позволяет работать со следующими объектами:
- **users** (пользователи): получение списка всех пользователей, создание пользователя, получение информации о пользователя по username, изменение данных пользователя, удаление пользователя, получение данных своей учетной записи, изменение данных своей учетной записи;
- **titles** (произведения): получение список всех произведение, создание записи о произведении, получение информации о произведении, обновление информацию о произведении, удаление произведения;
- **categories** (категории):  получение списка всех категорий, создание категории, удаление категории
- **genres** (жанры): получение списка всех жанров, создание жанра, удаление жанр;
- **reviews** (отзывы к произведению): получение списка всех отзывов, создание нового отзыва, получение отзыва, обновление отзыва, удаление отзыва;
- **comments** (комментарии к отзывам): получение списка всех комментариев к отзыву, создание комментария, получение комментария, обновление комменраия, удаление комментария. 

### Алгоритм регистрации пользователей
1. Пользователь отправляет POST-запрос на добавление нового пользователя с 
параметрами email и username на эндпоинт /api/v1/auth/signup/.
2. YaMDB отправляет письмо с кодом подтверждения (confirmation_code) на адрес email.
3. Пользователь отправляет POST-запрос с параметрами username и 
confirmation_code на эндпоинт /api/v1/auth/token/, в ответе на запрос ему 
приходит token (JWT-токен). В результате пользователь получает токен и может 
работать с API проекта, отправляя этот токен с каждым запросом.
4. Для повторного получения письма с кодом подтверждения пользователь отправляет
POST-запрос с параметрами username и email на эндпоинт /api/v1/auth/remind/.
5. При желании пользователь отправляет PATCH-запрос на эндпоинт 
/api/v1/users/me/ и заполняет поля в своём профайле.
6. Если пользователя создаёт администратор, например, через POST-запрос на 
эндпоинт api/v1/users/ — письмо с кодом также приходит к нему на почту.

### Пользовательские роли
* **Аноним** — может просматривать описания произведений, читать отзывы и комментарии.
* **Аутентифицированный пользователь (user)** — может, как и Аноним, читать всё, 
дополнительно он может публиковать отзывы и ставить оценку произведениям 
(фильмам/книгам/песням), может комментировать чужие отзывы; может редактировать 
и удалять свои отзывы и комментарии. Эта роль присваивается по умолчанию 
каждому новому пользователю.
* **Модератор (moderator)** — те же права, что и у Аутентифицированного
пользователя плюс право удалять любые отзывы и комментарии.
* **Администратор (admin)** — полные права на управление всем контентом проекта. 
Может создавать и удалять произведения, категории и жанры. Может назначать 
роли пользователям.
* **Суперюзер Django** — обладает правами администратора (admin). Даже если 
изменить пользовательскую роль суперюзера — это не лишит его прав администратора.

## Технологии
- Python 3.7
- Django 2.2.16
- Django Rest Framework 3.12.4
- PostgreSQL 13.0
- Nginx 1.19.3
- Gunicorn 20.0.4
- Docker 24.0.2
- Docker Compose 1.25.0

## Запуск проекта локально:

* Клонировать репозиторий и перейти в него в командной строке;

```
git clone git@github.com:MaryMash/yamdb_final.git
```
* Перейти в директорию /infra
```
cd infra
```

* В директории /infra создать файл .env. Пример заполнения:

```
DB_ENGINE=django.db.backends.postgresql # указываем, что работаем с postgresql
DB_NAME=postgres # имя базы данных
POSTGRES_USER=postgres # логин для подключения к базе данных
POSTGRES_PASSWORD=postgres # пароль для подключения к БД (установите свой)
DB_HOST=db # название сервиса (контейнера)
DB_PORT=5432 # порт для подключения к БД 
```

* Запустить контейнер;

```
docker-compose up -d
```

* Выполнить миграции

```
docker-compose exec web python manage.py migrate
```
* Создать суперпользователя

```
docker-compose exec web python manage.py createsuperuser
```

* Собрать статику

```
docker-compose exec web python manage.py collectstatic --no-input 
```

* Скопировать в контейнер файл с фикстурами для загрузки в БД:

```
docker cp fixtures.json infra_web_1:app/
```

* Загрузить данные в базу:

```
docker-compose exec web python manage.py loaddata fixtures.json
```

Проект должен быть доступен по адресу: http://localhost/admin
Документация: http://localhost/api/docs/

## Запуск проекта на боевом сервере:
* Установить на сервере docker и docker-compose
* Остановить службу nginx, если он запущен:
```
 sudo systemctl stop nginx
```
* Скопировать на сервер файлы docker-compose.yaml и default.conf из директории /infra:
```
scp docker-compose.yaml <логин_на_сервере>@<IP_сервера>:/home/<логин_на_сервере>/docker-compose.yaml
scp default.conf <логин_на_сервере>@<IP_сервера>:/home/<логин_на_сервере>/nginx/docker-compose.yaml
```
Добавить переменные в Secrets: 
```
DB_ENGINE=django.db.backends.postgresql # указываем, что работаем с postgresql
DB_NAME=postgres # имя базы данных
POSTGRES_USER=postgres # логин для подключения к базе данных
POSTGRES_PASSWORD=postgres # пароль для подключения к БД
DB_HOST=db # название сервиса БД (контейнера) 
DB_PORT=5432 # порт для подключения к БД
DOCKER_PASSWORD= # Пароль от аккаунта на DockerHub
DOCKER_USERNAME= # Username в аккаунте на DockerHub
HOST= # IP удалённого сервера
USER= # Логин для подключения к удалённому серверу
SSH_KEY= # SSH-key компьютера, с которого будет происходить подключение к удалённому серверу, команда для получения:  cat ~/.ssh/id_rsa
 
PASSPHRASE= #Если для ssh используется фраза-пароль
TELEGRAM_TO= #ID пользователя в Telegram
TELEGRAM_TOKEN= #ID бота в Telegram
```

* Сделать коммит:
```
git add .
git commit -m "commit message"
git push
```
* После того как в gihub будут запушены изменения, запустятся следующие процессы:
1. проверка кода на соответствие стандарту PEP8 
2. запуск pytest
3. сборка и обновление докер-образа для контейнера web на Docker Hub
4. автоматический деплой проекта на боевой сервер
5. отправка уведомления в Telegram об успешном завершении процесса

## Авторы:
[MaryMash](https://github.com/MaryMash)
- Управление пользователями: система регистрации и аутентификации, права доступа, работа с токеном, система подтверждения e-mail, поля.
- Импорт данных в БД из csv файлов.
- Настройка деплоя через docker-compose. 
- Настройка процесса CI  с использованием GitHub Actions.

[dddutlovv](https://github.com/dddutlovv)
- Реализация эндпоинтов: произведения, катеории, жанры;

[alexxxlexxx](https://github.com/alexxxlexxx)
- Реализация эндпоинтов: отзывы, комментарии, рейтинг;